<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<style>
		.chart-container {
			max-width: 400px;
			/* Set the maximum width of the chart */
			width: 100%;
			/* Make the chart take up the full width of its container */
			position: relative;
			/* Needed for responsiveness */
		}
	</style>
	<script src="/webjars/jquery/3.6.4/jquery.min.js"></script>
	<link rel="stylesheet" href="/webjars/bootstrap/5.3.0/css/bootstrap.min.css">
	<link rel="stylesheet" href="/webjars/datatables-buttons/2.4.1/css/buttons.dataTables.min.css">
</head>

<body>
	<header th:replace="fragments/header :: header"></header>
	<div class="container-fluid">
		<!-- Left Side Menu -->
		<div class="row">
			<div th:replace="fragments/sidebar :: sidebar"></div>
			<div class="col-md-10">
				<div th:replace="fragments/yearselect :: navbar"></div>
				<h4>Expenses Statement for <span th:text="${companyName}">Company</span> for the year ended
					<span th:text="${'AU ' + fiscal_end_day + ' ' + fiscal_end_month + ' ' + fiscal_end_year}"></span>
				</h4>
				<div class="container shadow min-vh-100 py-2">
					<h4>Operating Expenses</h4>
					<div class="chart-container">
						<canvas id="spendingChart" width="100" height="100"></canvas>
					</div>
					<table class="table table-striped">
						<thead>
							<tr>
								<th>DATE</th>
								<th>TYPE</th>
								<th>NO.</th>
								<th>PAYEE</th>
								<th>CATEGORY</th>
								<th>MEMO</th>
								<th>TOTAL BEFORE SALES TAX</th>
								<th>SALES TAX</th>
								<th>TOTAL</th>
								<th>ACTION</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="line : ${expenses}">
								<td th:text="${line.date}"> </td>
								<td th:text="${line.expenseType}"></td>
								<td th:text="${line.id}"></td>
								<td th:text="${line.payee}"></td>
								<td th:text="${line.expenseType}"></td>
								<td th:text="${line.description}"></td>
								<td th:text="${line.tbst}"></td>
								<td th:text="${line.st}"></td>
								<td th:text="${#numbers.formatDecimal(line.amount, 1, 'COMMA', 2, 'POINT')}+'$'"></td>
								<td>
									<button class="btn btn-primary edit-button" th:data-id="${line.id}">Edit</button>
								</td>
							</tr>
							<tr>
								<td th:text="${totals.description}"></td>
								<td> </td>
								<td> </td>
								<td> </td>
								<td> </td>
								<td> </td>
								<td th:text="${#numbers.formatDecimal(totals.tbst, 1, 'COMMA', 2, 'POINT')}+'$'"></td>
								<td th:text="${#numbers.formatDecimal(totals.st, 1, 'COMMA', 2, 'POINT')}+'$'"></td>
								<td th:text="${#numbers.formatDecimal(totals.amount, 1, 'COMMA', 2, 'POINT')}+'$'"></td>



							</tr>
						</tbody>
					</table>
				</div>
				<div class="container shadow min-vh-100 py-2">
					<h4>Other Expenses</h4>
					<table class="table table-striped">
						<thead>
							<tr>
								<th>Description</th>

								<th>Amount</th>
								<th>Date</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="line : ${otherExpenses}">
								<td th:text="${line.description}"></td>

								<td th:text="${#numbers.formatDecimal(line.amount, 1, 'COMMA', 2, 'POINT')}+'$'"></td>
								<td th:text="${line.date}"> </td>
							</tr>
							<tr>
								<td th:text="${totalOthers.description}"></td>
								<td th:text="${#numbers.formatDecimal(totalOthers.amount, 1, 'COMMA', 2, 'POINT')}+'$'">
								</td>
								<td> </td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
	<div id="editModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
		aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>

				<form id="editExpenseForm">
					<label for="description">Description:</label>
					<input type="text" id="description" name="description" required><br><br>
					<!-- Add other fields as needed -->
					<label for="invoices">Select Invoice:</label>
					<select class="form-control" id="invoices" name="invoices">
						<!-- Option values will be filled dynamically -->
					</select>
					<input type="submit" value="Save Changes">
				</form>
				<div class="container my-3">
					<h2 class="text-center">Transaction Details</h2>
					<div style="max-height: 200px; overflow-y: auto;"> <!-- Add scrollable div -->
						<table class="table table-striped table-responsive"> <!-- Add table-responsive class -->
							<thead class="thead-dark">
								<tr>
									<th>Date</th>
									<th>Account</th>
									<th>Description</th>
									<th>Amount</th>
									<th>Type</th>
									<th>Is Cash Flow</th>
									<th>Note</th>
								</tr>
							</thead>
							<tr>
								<td id='transaction.date'></td>
								<td id='transaction.account'></td>
								<td id='transaction.description'></td>
								<td id='transaction.amount'></td>
								<td id='transaction.type'></td>
								<td id='transaction.isCashFlow'></td>
								<td id='transaction.note'></td>
							</tr>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>

</body>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/webjars/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
	// Get the spending data from the Thymeleaf model
	var spendingData = /*[[${spendingData}]]*/ {};

	// Prepare the labels and values for the pie chart
	var labels = Object.keys(spendingData);
	var values = Object.values(spendingData);

	// Get the canvas element
	var ctx = document.getElementById('spendingChart').getContext('2d');

	// Create the pie chart
	var myPieChart = new Chart(ctx, {
		type: 'pie',
		data: {
			labels: labels,
			datasets: [{
				data: values,
				backgroundColor: [
					// You can define colors for each segment here
					'red', 'blue', 'green', 'yellow', 'orange'// ...
				]
			}]
		}
	});
</script>
<script th:inline="javascript">
	// Get the modal
	var modal = document.getElementById('editModal');

	// Get the <span> element that closes the modal
	var span = document.getElementsByClassName("close")[0];

	// When the user clicks on <span> (x), close the modal
	span.onclick = function () {
		var myModal = new bootstrap.Modal(document.getElementById('editModal'), {});
		myModal.hide();
		$('#editModal').modal('hide');
	}

	// When the user clicks anywhere outside of the modal, close it
	window.onclick = function (event) {
		if (event.target == modal) {
			var myModal = new bootstrap.Modal(document.getElementById('editModal'), {});
			myModal.hide();
		}
	}

	// Add event listener to all edit buttons
	var editButtons = document.getElementsByClassName('edit-button');
	Array.from(editButtons).forEach(function (button) {
		button.addEventListener('click', function (e) {
			var expenseId = e.target.dataset.id;

			$.get("/api/expenses/" + expenseId, function (data) {
				// `data` contains the JSON response from your server. You can now populate the modal with this information.

				// Example: Set the description field in the modal
				$("#transaction.description").val(data.transaction.description);
				$("#transaction\\.date").text(data.transaction.date);
				$("#transaction\\.account").text(data.transaction.account);
				$("#transaction\\.description").text(data.transaction.description);
				$("#transaction\\.amount").text(data.transaction.amount);
				$("#transaction\\.type").text(data.transaction.type);
				$("#transaction\\.isCashFlow").text(data.transaction.isCashFlow ? "Yes" : "No"); // Assuming it's a boolean value
				$("#transaction\\.note").text(data.transaction.note);
				// You could set other fields as well

				// Finally, show the modal (assuming you're using Bootstrap)
				$('#editModal').modal('show');
			})
				.fail(function () {
					alert("An error occurred while fetching the expense details.");
				});
			// Fetch the expense details and populate the form, or populate directly from table data

			$.ajax({
				url: "/api/invoice/findByExpenseId", // Update with your API endpoint
				method: "GET",
				data: {expenseId: expenseId},
				success: function (invoices) {
					// Clear existing options
					$("#invoices").empty();

					// Add a default option
					$("#invoices").append('<option value="">Select an Invoice</option>');

					// Loop through the invoices and append to the dropdown
					invoices.forEach(function (invoice) {
						$("#invoices").append('<option value="' + invoice.id + '">' + invoice.name + '</option>');
					});
				},
				error: function (err) {
					console.error("An error occurred while fetching the invoices:", err);
					// Handle the error as needed
				}
			});
			// Show the modal
			//modal.style.display = "block";
			//var myModal = new bootstrap.Modal(document.getElementById('editModal'), {});
			//myModal.show();
		});
	});

	// Handle form submission
	document.getElementById('editExpenseForm').addEventListener('submit', function (e) {
		e.preventDefault(); // Prevent normal form submission
		// Collect form data and send an AJAX request to update the expense
		// Update the table row with the new data if successful
		var myModal = new bootstrap.Modal(document.getElementById('editModal'), {});
		myModal.hide();
	});

	function editExpense(expenseId) {
		fetch("/api/attachment/preview/" + billId) // Replace "/preview/1" with the correct URL for the preview
			.then(response => response.text())
			.then(data => {
				document.getElementById("previewImage").src = "data:image/png;base64," + data;
				var previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
				previewModal.show();
			});


	}
</script>

</html>