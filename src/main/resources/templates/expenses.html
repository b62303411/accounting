<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<style>
		.chart-container {
			max-width: 300px;
			/* Set the maximum width of the chart */
			width: 100%;
			/* Make the chart take up the full width of its container */
			position: relative;
			/* Needed for responsiveness */
		}

		@media (max-width: 768px) {

			.table-responsive .table th,
			.table-responsive .table td {
				font-size: 12px;
				/* Adjust as needed */
			}
		}

		.table td,
		.table th {
			font-size: 8px;
		}
	</style>
	<link rel="stylesheet" href="/webjars/datatables-buttons/2.4.1/css/buttons.dataTables.min.css">
	<link rel="stylesheet" href="/webjars/datatables-colvis/1.1.1/css/dataTables.colVis.css">

	<link rel="stylesheet" href="/webjars/bootstrap/5.3.0/css/bootstrap.min.css">
	<link rel="stylesheet" href="/webjars/datatables-buttons/2.4.1/css/buttons.dataTables.min.css">
</head>

<body>
	<header th:replace="fragments/header :: header"></header>
	<div class="container-fluid">
		<!-- Left Side Menu -->
		<div class="row">
			<div th:replace="fragments/sidebar :: sidebar"></div>
			<div class="col-md-10">
				<div th:replace="fragments/yearselect :: navbar"></div>
				<div
					th:replace="fragments/reportHeader :: reportHeader('Expenses Statement', ${companyName}, ${fiscal_end_day}, ${fiscal_end_month}, ${fiscal_end_year})" />
				<div class="container">
					<ul class="nav nav-tabs" id="expenseTabs">
						<li class="nav-item">
							<a class="nav-link active" id="expenses-tab" data-bs-toggle="tab"
								href="#expenses">Expenses</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" id="bulkUpdate-tab" data-bs-toggle="tab" href="#bulkUpdate">Bulk
								Update</a>
						</li>
					</ul>
					<div class="tab-content" id="expenseTabsContent">
						<div class="tab-pane fade show active" id="expenses" role="tabpanel"
							aria-labelledby="expenses-tab">
							<!-- Content for Expenses Tab -->
							<div class="container shadow min-vh-100 py-2">
								<h4>Operating Expenses</h4>
								<div class="chart-container">
									<canvas id="spendingChart" width="50" height="50"></canvas>
								</div>
								<div class="table-responsive">
									<table id="expense-table" class="table table-striped table-responsive">
										<thead>
											<tr>
												<th>DATE</th>
												<th>TYPE</th>
												<th>NO.</th>
												<th>PAYEE</th>
												<th>CATEGORY</th>
												<th>MEMO</th>
												<th>TOTAL BEFORE SALES TAX</th>
												<th>SALES TAX</th>
												<th>TOTAL</th>
												<th>ACTION</th>
											</tr>
										</thead>
										<tbody>
											<tr th:each="line : ${expenses}">
												<td th:text="${line.date}"> </td>
												<td th:text="${line.expenseType}"></td>
												<td th:text="${line.id}"></td>
												<td th:text="${line.payee}"></td>
												<td th:text="${line.expenseType}"></td>
												<td th:text="${line.description}"></td>
												<td
													th:insert="fragments/formatCurrency::formattedCurrency(${line.tbst})">
												</td>
												<td th:insert="fragments/formatCurrency::formattedCurrency(${line.st})">
												</td>
												<td
													th:insert="fragments/formatCurrency::formattedCurrency(${line.amount})">
												</td>
												</td>
												<td>

													<a th:href="@{/view/expenses/{id}/edit(id=${line.id})}"
														class="btn btn-primary">Edit</a>
												</td>
											</tr>
											<tr>
												<td th:text="${totals.description}"></td>
												<td> </td>
												<td> </td>
												<td> </td>
												<td> </td>
												<td> </td>
												<td
													th:insert="fragments/formatCurrency::formattedCurrency(${totals.tbst})">
												</td>
												<td
													th:insert="fragments/formatCurrency::formattedCurrency(${totals.st})">
												</td>
												<td
													th:insert="fragments/formatCurrency::formattedCurrency(${totals.amount})">
												</td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>
						</div>
						<div class="tab-pane fade" id="bulkUpdate" role="tabpanel" aria-labelledby="bulkUpdate-tab">
							<!-- Include Thymeleaf Fragment for Bulk Update -->
							<div th:replace="fragments/bulk-update-fragment :: bulkUpdateForm"></div>
						</div>
					</div>
				</div>

				<hr> <!-- Horizontal line -->
				<div class="container shadow min-vh-100 py-2">
					<h4>Other Expenses</h4>
					<table class="table table-striped">
						<thead>
							<tr>
								<th>Description</th>

								<th>Amount</th>
								<th>Date</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="line : ${otherExpenses}">
								<td th:text="${line.description}"></td>

								<td th:text="${#numbers.formatDecimal(line.amount, 1, 'COMMA', 2, 'POINT')}+'$'"></td>
								<td th:text="${line.date}"> </td>
							</tr>
							<tr>
								<td th:text="${totalOthers.description}"></td>
								<td th:text="${#numbers.formatDecimal(totalOthers.amount, 1, 'COMMA', 2, 'POINT')}+'$'">
								</td>
								<td> </td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
	<div th:insert="fragments/expenseEditModalFragment :: editModal"></div>

</body>
<script src="/webjars/jquery/3.6.4/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/webjars/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="/webjars/datatables/1.13.5/js/dataTables.bootstrap5.min.js"></script>
<script src="/webjars/datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>

<script>
	$(document).ready(function () {
		$('#expense-table').DataTable({
			dom: 'Bfrtip',
			buttons: [
				{
					extend: 'csvHtml5',
					text: 'Export CSV',
					className: 'exportButton'
				},
				{
					extend: 'pdfHtml5',
					text: 'Export PDF',
					className: 'exportButton'
				},
				{
					extend: 'colvis',
					text: 'Filter by column',
					className: 'filterButton'
				}
			]
		});
	});
</script>
<script th:inline="javascript">


	// Get the spending data from the Thymeleaf model
	var spendingData = /*[[${spendingData}]]*/ {};

	// Prepare the labels and values for the pie chart
	var labels = Object.keys(spendingData);
	var values = Object.values(spendingData);

	// Get the canvas element
	var ctx = document.getElementById('spendingChart').getContext('2d');

	// Create the pie chart
	var myPieChart = new Chart(ctx, {
		type: 'pie',
		data: {
			labels: labels,
			datasets: [{
				data: values,
				backgroundColor: [
					// You can define colors for each segment here
					'red', 'blue', 'green', 'yellow', 'orange'// ...
				]
			}]
		}
	});
</script>
<script th:inline="javascript">
	// Get the modal
	var modal = document.getElementById('editModal');

	// Get the <span> element that closes the modal
	var span = document.getElementsByClassName("close")[0];

	// When the user clicks on <span> (x), close the modal
	span.onclick = function () {
		var myModal = new bootstrap.Modal(document.getElementById('editModal'), {});
		myModal.hide();
		$('#editModal').modal('hide');
	}

	// When the user clicks anywhere outside of the modal, close it
	window.onclick = function (event) {
		if (event.target == modal) {
			var myModal = new bootstrap.Modal(document.getElementById('editModal'), {});
			myModal.hide();
		}
	}

	// Add event listener to all edit buttons
	/*
	var editButtons = document.getElementsByClassName('edit-button');
	Array.from(editButtons).forEach(function (button) {
		button.addEventListener('click', function (e) {
			var expenseId = e.target.dataset.id;

			$.get("/api/expenses/" + expenseId, function (data) {
				// `data` contains the JSON response from your server. You can now populate the modal with this information.

				// Example: Set the description field in the modal
				$("#transaction.description").val(data.transaction.description);
				$("#transaction\\.date").text(data.transaction.date);
				$("#transaction\\.account").text(data.transaction.account);
				$("#transaction\\.description").text(data.transaction.description);
				$("#transaction\\.amount").text(data.transaction.amount);
				$("#transaction\\.type").text(data.transaction.type);
				$("#transaction\\.isCashFlow").text(data.transaction.isCashFlow ? "Yes" : "No"); // Assuming it's a boolean value
				$("#transaction\\.note").text(data.transaction.note);
				// You could set other fields as well

				// Finally, show the modal (assuming you're using Bootstrap)
				$('#editModal').modal('show');
			})
				.fail(function () {
					alert("An error occurred while fetching the expense details.");
				});
			// Fetch the expense details and populate the form, or populate directly from table data

			$.ajax({
				url: "/api/invoice/findByExpenseId", // Update with your API endpoint
				method: "GET",
				data: {expenseId: expenseId},
				success: function (invoices) {
					// Clear existing options
					$("#invoices").empty();

					// Add a default option
					$("#invoices").append('<option value="">Select an Invoice</option>');

					// Loop through the invoices and append to the dropdown
					invoices.forEach(function (invoice) {
						$("#invoices").append('<option value="' + invoice.id + '">' + invoice.name + '</option>');
					});
				},
				error: function (err) {
					console.error("An error occurred while fetching the invoices:", err);
					// Handle the error as needed
				}
			});
			// Show the modal
			//modal.style.display = "block";
			//var myModal = new bootstrap.Modal(document.getElementById('editModal'), {});
			//myModal.show();
		});
	});
	*/
	// Handle form submission
	document.getElementById('editExpenseForm').addEventListener('submit', function (e) {
		e.preventDefault(); // Prevent normal form submission
		// Collect form data and send an AJAX request to update the expense
		// Update the table row with the new data if successful
		var myModal = new bootstrap.Modal(document.getElementById('editModal'), {});
		myModal.hide();
	});

	function editExpense(expenseId) {
		fetch("/api/attachment/preview/" + expenseId) // Replace "/preview/1" with the correct URL for the preview
			.then(response => response.text())
			.then(data => {
				document.getElementById("previewImage").src = "data:image/png;base64," + data;
				var previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
				previewModal.show();
			});


	}



</script>
<script>

		document.getElementById("bulkActionForm").addEventListener("submit", function (event) {
			event.preventDefault();

			var formData = {
				description: document.getElementById("description").value,
				newType: document.getElementById("newType").value
			};

			fetch("/api/expenses/bulkupdate", {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify(formData)
			})
				.then(response => response.json())
				.then(data => {
					// Handle response here. e.g., show a success message or update the UI
				})
				.catch(error => console.error('There was an error!', error));
		});

</script>

</html>